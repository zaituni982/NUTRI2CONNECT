{% extends 'nutriconnect/base.html' %}
{% load static %}

{% block title %}Marketplace & Payment{% endblock %}

{% block content %}

<style>
/* CSS for the M-Pesa Payment Form */
.payment-form {
    max-width: 450px;
    margin: 50px auto;
    background: #ffffff;
    padding: 40px 30px;
    border-radius: 12px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.15);
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
}

.payment-form h2 {
    text-align: center;
    color: #ff6f61;
    margin-bottom: 25px;
    font-size: 28px;
}

.payment-form .form-group {
    margin-bottom: 20px;
}

.payment-form label {
    display: block;
    margin-bottom: 8px;
    font-weight: 600;
    color: #333;
}

.payment-form input {
    width: 100%;
    padding: 14px 16px;
    border: 1px solid #ccc;
    border-radius: 8px;
    font-size: 16px;
    outline: none;
    transition: border-color 0.3s, box-shadow 0.3s;
}

.payment-form input:focus {
    border-color: #ff6f61;
    box-shadow: 0 0 8px rgba(255,111,97,0.3);
}

.payment-form .btn {
    width: 100%;
    padding: 14px;
    background: #ff6f61;
    color: white;
    font-weight: bold;
    border: none;
    border-radius: 8px;
    font-size: 16px;
    cursor: pointer;
    transition: background 0.3s, transform 0.2s;
}

.payment-form .btn:hover {
    background: #ff4b3e;
    transform: translateY(-2px);
}

@media (max-width: 600px) {
    .payment-form { padding: 30px 20px; }
    .payment-form h2 { font-size: 24px; }
}
</style>

<section style="background: url('https://source.unsplash.com/random/1600x600/?farm,agriculture&v=1') no-repeat center center; background-size: cover; padding: 80px 20px; color: black; text-align: center;">
    <h1 style="font-size: 3rem; font-weight: bold;">Welcome to NUTRI-2-CONNECT Marketplace</h1>
    <p style="font-size: 1.2rem; margin-top: 10px;">Connect with farmers, explore fresh produce, and make secure transactions easily.</p>
    <a href="#farmers" style="margin-top: 20px; display: inline-block; padding: 12px 25px; background-color: #ff7f50; color: rgb(17, 6, 6); border-radius: 6px; font-weight: bold; text-decoration: none;">Explore Farmers</a>
</section>

<section id="farmers" style="padding: 50px 20px; background-color: #f4f4f4;">
    <h2 style="text-align: center; color: #2d6a4f; margin-bottom: 30px;">Farmers Listing</h2>

    <div style="text-align:center; margin-bottom: 25px;">
        <img src="https://www.freepik.com/free-vector/hand-drawn-flat-design-farmers-market-banner_24489806.htm#fromView=keyword&page=1&position=46&uuid=4deb4359-a47d-4a7c-9ce3-524cff2496d9&query=Farmers+banner"
             alt="Farmers Banner"
             style="width: 90%; max-width: 700px; border-radius: 10px;">
    </div>

    <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 20px;">
        {% for farmer in farmers %}
        <div style="background: white; padding: 20px; border-radius: 8px; width: 250px; box-shadow: 0 4px 6px rgba(0,0,0,0.1); text-align: center;">
            <img src="https://images.pexels.com/photos/18076420/pexels-photo-18076420.jpeg"
                 alt="Farmer" style="width: 180px; height: 150px; margin-bottom: 10px;">
            <h3>{{ farmer.name }}</h3>
            <p><strong>Farm:</strong> {{ farmer.farm_name }}</p>
            <p><strong>Location:</strong> {{ farmer.location }}</p>
            <p><strong>Produce:</strong> {{ farmer.produce_type }}</p>
            <a href="{% url 'farmer_produce' farmer.id %}"
               style="display: inline-block; margin-top: 10px; padding: 8px 15px; background: #2d6a4f; color: white; border-radius: 5px; text-decoration: none; font-size: 14px;">
               View Produce
            </a>
        </div>
        {% empty %}
        <p>No farmers available at the moment.</p>
        {% endfor %}
    </div>
</section>

<section id="offers" style="padding: 50px 20px; text-align: center;">
    <h2 style="color: #2d6a4f; margin-bottom: 30px;">Current Offers</h2>

    <div style="text-align:center; margin-bottom: 25px;">
        <img src="https://source.unsplash.com/random/1100x350/?fresh,vegetables,deals&v=4"
             alt="Offers Showcase"
             style="width: 65%; max-width: 650px; border-radius: 10px;">
    </div>

    <div style="display: flex; flex-wrap: wrap; justify-content: center; gap: 20px;">
        {% for offer in offers %}
        <div style="background: #ffffff; padding: 20px; border-radius: 8px; width: 220px; box-shadow: 0 4px 6px rgba(0,0,0,0.1);">
            <img src="https://source.unsplash.com/random/70x70/?fruit,produce&v=5"
                 alt="Offer" style="width: 70px; height: 70px; margin-bottom: 10px;">
            <h3>{{ offer.produce.name }}</h3>
            <p><strong>Price:</strong> KSH {{ offer.price }}</p>
            <p><strong>Farmer:</strong> {{ offer.farmer.name }}</p>
            <a href="{% url 'buy_produce' offer.produce.id %}"
               style="display: inline-block; margin-top: 10px; padding: 8px 15px; background: #ff6f61; color: white; border-radius: 5px; text-decoration: none;">
               Buy Now
            </a>
        </div>
        {% empty %}
        <p>No offers available at the moment.</p>
        {% endfor %}
    </div>
</section>

<section style="padding: 50px 20px;">
    <form method="POST" action="{% url 'initiate_payment' %}" class="payment-form">
        {% csrf_token %}
        <h2>M-Pesa Payment</h2>

        <input type="hidden" name="produce_id" value="{{ produce.id }}">

        <div class="form-group">
            <label for="phone">Phone Number (e.g., 07XXXXXXXX):</label>
            <input type="text" id="phone" name="phone" placeholder="0712345678" required>
        </div>

        <div class="form-group">
            <label for="amount">Amount (KSH):</label>
             <input type="number" id="amount" name="amount" value="{{ produce.price }}" required>
        </div>

        <input type="hidden" id="produce_id" name="produce_id" value="">

        <button type="submit" class="btn">Pay Now (STK Push)</button>
    </form>
</section>

<script>
// Prefill the payment form with produce amount when "Buy Now" is clicked
document.querySelectorAll('a[href^="{% url "buy_produce" 0 %}"]').forEach(link => {
    link.addEventListener('click', function(event) {
        event.preventDefault();
        const produceId = this.href.split('/').slice(-2, -1)[0];
        const price = parseInt(this.closest('div').querySelector('p strong + text').textContent.replace('KSH ', '')) || 0;

        document.getElementById('produce_id').value = produceId;
        document.getElementById('amount').value = price;
        window.scrollTo({ top: document.querySelector('.payment-form').offsetTop, behavior: 'smooth' });
    });
});
</script>

{% endblock %}
